---
title: "EDA"
output: html_notebook
---

## Variable Descriptions

Patient_ID Unique anonymized identifier per patient
Visit_Number Sequential clinical visit index
Visit_Timestamp Date of each visit
Scan_Type Type of scan performed (Ultrasound, FNA, Elastography)
Age, Gender, Height, Weight, BMI Basic demographics and body metrics
Family_History Binary indicator for thyroid disease in family history
Smoking_Status Categorical: Smoker, Non-Smoker, Former Smoker
Radiation_Exposure Prior exposure to radiation therapy or sources
Nodule_Size_mm, Margin_Sharpness, Shape_Score, Echogenicity_Index Radiomic features from scans

Calcification_Presence, Capsular_Invasion_Indicator Structural indicators linked to malignancy

Vascularity_Score, Texture_Entropy, Asymmetry_Score Advanced scan-derived imaging biomarkers

TSH_Risk_Level, TPOAb_Probability, Thyroglobulin_Level_Predicted, Calcitonin_Level_Predicted, Reverse_T3_Index Hormonal indicators
Heart_Rate, Daily_Steps, Sleep_Patterns, Body_Temperature, Pulse_Oximetry Smart device vitals

Stress_Level, Symptom_Onset_Duration, Hormonal_Change_Rate, Medication_Adherence Behavioral and progression indicators

Diagnosis_Label Binary classification (0: Benign, 1: Malignant)
Cancer_Type Categorical subtype (e.g., Papillary, Follicular, Medullary, etc.)

Recurrence_Risk Binary risk estimation for recurrence likelihood

```{r Downloading packages and Importing Dataset}
library(readr)
library(ggplot2)
library(purrr)
library(tidyverse)
library(cowplot)
library(MASS)
library(lavaan)

thyro <- read_csv("~/Desktop/UM/BIOSTAT625/Project//ThyroTrack-MV Processed Dataset.csv", show_col_types = F)
```

``` {r Data manipulation and cleaning}
patient_freq = 
  thyro %>% 
  group_by(Patient_ID) %>% 
  summarize(n = n()) 

patient_freq4 = patient_freq %>% 
  filter(n >= 4)

patient_freq4 = patient_freq4$Patient_ID

thyro4 =
  thyro %>% 
  filter(Patient_ID %in% patient_freq4) %>% 
  group_by(Patient_ID) %>% 
  mutate(
    across(c(4, 6, 10, 11, 12, 17, 21, 22, 35, 36, 37, 38) - 1, as.factor)
  )  %>% 
  mutate(
    elapsed_time_days = as.numeric((Visit_Timestamp - min(Visit_Timestamp)))
  ) %>% 
  ungroup() %>% 
  group_by(Patient_ID) %>% 
  mutate(
    elapsed_time_prop = elapsed_time_days / max(elapsed_time_days)
  ) %>% 
  ungroup() 
         

ranking = thyro4 %>% 
  group_by(Patient_ID) %>% 
  summarize(
    ave_visitFreq = max(elapsed_time_days) / max(Visit_Number)
  ) %>% 
  mutate(rank_visitFreq = as.factor(ntile(ave_visitFreq, 4))) %>% 
  ungroup() 

thyro4 = thyro4 %>% 
  left_join(., y = ranking, by = "Patient_ID", keep = F) %>% 
  dplyr::select(-c(ave_visitFreq))


```


```{r Continuous indicators non-transformed}
L1 = list(
thyro4 %>%
  ggplot(aes(
    x = Thyroglobulin_Level_Predicted,
  )) +
  geom_density(alpha = 0.50,
               fill = "purple3",
               adjust = 2) +
  xlab("Tg not transformed")
,
thyro4 %>%
  ggplot(aes(
    x = Calcitonin_Level_Predicted
  )) +
  geom_density(alpha = 0.50,
               fill = "purple3",
               adjust = 2) +
  xlab("Ct not transformed")
,
thyro4 %>%
  ggplot(aes(
    x = Reverse_T3_Index
  )) +
  geom_density(alpha = 0.50,
               fill = "purple3",
               adjust = 2) +
  xlab("rT3 as is")
)


```

 
```{r Box Cox transforming continuous indicators}
m1 <- lm(Thyroglobulin_Level_Predicted + 1e-6 ~ 1, data = thyro4)
bc1 = MASS::boxcox(m1, plotit = TRUE)
optLamda_tg = bc1$x[which.max(bc1$y)]


m2 <- lm(Calcitonin_Level_Predicted + 1e-6 ~ 1, data = thyro4)
bc2 = MASS::boxcox(m2, plotit = TRUE)
optLambda_calc = bc2$x[which.max(bc2$y)]

thyro4 = thyro4 %>% 
  mutate(
    `TgT` = 
      ((Thyroglobulin_Level_Predicted + 1e-6)^0.25 - 1) / 0.25,
    `CtT` = ((Calcitonin_Level_Predicted + 1e-6)^0.25 -1) / 0.25,
    rT3 = Reverse_T3_Index
  )

rm(optLambda_calc, optLamda_tg, ranking, bc1, bc2, m1, m2)
```


#### Exploratory Data Analysis 

```{r Graphs of transformed continuous indicators}
L2 =
list(thyro4 %>%
  ggplot(aes(
    x = TgT,
  )) +
  geom_density(alpha = 0.50,
               fill = "lightblue",
               adjust = 2)+
    xlab("Tg transformed")
,
thyro4 %>%
  ggplot(aes(
    x = CtT
  )) +
  geom_density(alpha = 0.50,
               fill = "lightblue",
               adjust = 2)+
  xlab("Ct transformed")
,
thyro4 %>%
  ggplot(aes(
    x = rT3
  )) +
  geom_density(alpha = 0.50,
               fill = "lightblue",
               adjust = 2) +
  xlab("rT3 as is")
)

plot_grid(plotlist = c(L1, L2))
```


```{r Graphs of transformed continuous indicators w.r.t. discrete indicators}
plotList1 = list(
  thyro4 %>%
    ggplot(aes(
      x = TgT,
      group = TSH_Risk_Level,
      fill = factor(TSH_Risk_Level)
    )) +
    geom_density(alpha = 0.1),
  
  thyro4 %>%
    ggplot(aes(
      x = CtT,
      group = TSH_Risk_Level
    )) +
    geom_density(alpha = 0.1),
  
  thyro4 %>%
    ggplot(
      aes(
        x = rT3,
        group = TSH_Risk_Level,
        fill = factor(TSH_Risk_Level)
      )
    ) +
    geom_density(alpha = 0.1),
  
)

```


```{r bc(Tg + 1) on bc(Calc + 1), bc(Tg + 1) on Hormonal, and bc(Calc + 1) on Horm. }

list(thyro4 %>% 
  ggplot(aes(x = rT3, y = TgT)) +
  geom_point() 
,
thyro4 %>% 
  ggplot(aes(x = TgT, y = CtT)) +
  geom_point() 
,
thyro4 %>% 
  ggplot(aes(x = CtT, y = rT3)) +
  geom_point())

list(
  cor(thyro4$rT3, thyro4$CtT),
  cor(thyro4$rT3, thyro4$TgT),
  cor(thyro4$TgT, thyro4$CtT)
)
```
Completely uncorrelated!

```{r}
thyro4 
  
```




```{r Longitudinal trends of TgT across all discrete indicators}
d1 = thyro4 %>%
  group_by(
    Visit_Number,
    TSH_Risk_Level,
    Calcification_Presence,
    Gender,
    factor(Age > 50),
    Cancer_Type
    ) %>%
  summarise(
    medianPropTime = median(elapsed_time_prop),
    q1PropTime = quantile(elapsed_time_prop, 0.25),
    q3PropTime = quantile(elapsed_time_prop, 0.75),
    medianTg = median(TgT),
    q1Tg = quantile(TgT, 0.25),
    q3Tg = quantile(TgT, 0.75),
    medianCt = median(CtT),
    q1CtT = quantile(CtT, 0.25),
    q3CtT = quantile(CtT, 0.75),
    medianrT3 = median(rT3),
    q1rT3 = quantile(rT3, 0.25),
    q3rT3 = quantile(rT3, 0.75)
  ) %>% 
  as.data.frame() 

d1.1 = d1 %>% 
  group_by(Visit_Number) %>% 
  summarize(medPT =  median(medianPropTime), 
            medTgT =  median(medianTg), 
            medCt = median(medianCt),
            medrT3 = median(medianrT3))

d1.2 = d1 %>% 
  group_by(Visit_Number, `factor(Age > 50)`) %>% 
  summarize(medPT =  median(medianPropTime), 
            medTgT =  median(medianTg), 
            medCt = median(medianCt),
            medrT3 = median(medianrT3))

d1.3 = d1 %>% 
  group_by(Visit_Number, Gender) %>% 
  summarize(medPT =  median(medianPropTime), 
            medTgT =  median(medianTg), 
            medCt = median(medianCt),
            medrT3 = median(medianrT3))

d1.4 = d1 %>% 
  group_by(Visit_Number, TSH_Risk_Level) %>% 
  summarize(medPT =  median(medianPropTime), 
            medTgT =  median(medianTg), 
            medCt = median(medianCt),
            medrT3 = median(medianrT3))

d1.5 = d1 %>% 
  group_by(Visit_Number, Calcification_Presence) %>% 
  summarize(medPT =  median(medianPropTime), 
            medTgT =  median(medianTg), 
            medCt = median(medianCt),
            medrT3 = median(medianrT3))

d1.6 = d1 %>% 
  group_by(Visit_Number, Cancer_Type) %>% 
  summarize(medPT =  median(medianPropTime), 
            medTgT =  median(medianTg), 
            medCt = median(medianCt),
            medrT3 = median(medianrT3))
```

``` {r}
p1 = list(
d1 %>% 
  ggplot(aes(x = medianPropTime, y = medianTg)) +
  geom_point() +
  geom_line(data = d1.1, aes(x = medPT, y = medTgT), linewidth = 1, alpha = 0.3) +
  geom_line(data = d1.2, aes(x = medPT, y = medTgT, group = `factor(Age > 50)`, 
                             color = `factor(Age > 50)`))
,
d1 %>% 
  ggplot(aes(x = medianPropTime, y = medianTg)) +
  geom_point() +
  geom_line(data = d1.1, aes(x = medPT, y = medTgT), linewidth = 1, alpha = 0.3) +
  geom_line(data = d1.3, aes(x = medPT, y = medTgT, group = Gender, 
                             color = Gender))
,
d1 %>% 
  ggplot(aes(x = medianPropTime, y = medianTg)) +
  geom_point() +
  geom_line(data = d1.1, aes(x = medPT, y = medTgT), linewidth = 1, alpha = 0.3) +
  geom_line(data = d1.4, aes(x = medPT, y = medTgT, group = TSH_Risk_Level, 
                             color = TSH_Risk_Level))
,
d1 %>% 
  ggplot(aes(x = medianPropTime, y = medianTg)) +
  geom_point() +
  geom_line(data = d1.1, aes(x = medPT, y = medTgT), linewidth = 1, alpha = 0.3) +
  geom_line(data = d1.5, aes(x = medPT, y = medTgT, group = Calcification_Presence, 
                             color = Calcification_Presence))
,
d1 %>% 
  ggplot(aes(x = medianPropTime, y = medianTg)) +
  geom_point() +
  geom_line(data = d1.1, aes(x = medPT, y = medTgT), linewidth = 1, alpha = 0.3) +
  geom_line(data = d1.6, aes(x = medPT, y = medTgT, group = Cancer_Type, 
                             color = Cancer_Type))
)

```


```{r Longitudinal trends of CtT center across all discrete indicators}

p2 = list(
d1 %>% 
  ggplot(aes(x = medianPropTime, y = medianCt)) +
  geom_point() +
  geom_line(data = d1.1, aes(x = medPT, y = medCt), linewidth = 1, alpha = 0.3) +
  geom_line(data = d1.2, aes(x = medPT, y = medCt, group = `factor(Age > 50)`, 
                             color = `factor(Age > 50)`))
,
d1 %>% 
  ggplot(aes(x = medianPropTime, y = medianCt)) +
  geom_point() +
  geom_line(data = d1.1, aes(x = medPT, y = medCt), linewidth = 1, alpha = 0.3) +
  geom_line(data = d1.3, aes(x = medPT, y = medCt, group = Gender, 
                             color = Gender))
,
d1 %>% 
  ggplot(aes(x = medianPropTime, y = medianCt)) +
  geom_point() +
  geom_line(data = d1.1, aes(x = medPT, y = medCt), linewidth = 1, alpha = 0.3) +
  geom_line(data = d1.4, aes(x = medPT, y = medCt, group = TSH_Risk_Level, 
                             color = TSH_Risk_Level))
,
d1 %>% 
  ggplot(aes(x = medianPropTime, y = medianCt)) +
  geom_point() +
  geom_line(data = d1.1, aes(x = medPT, y = medCt), linewidth = 1, alpha = 0.3) +
  geom_line(data = d1.5, aes(x = medPT, y = medCt, group = Calcification_Presence, 
                             color = Calcification_Presence))
,
d1 %>% 
  ggplot(aes(x = medianPropTime, y = medianCt)) +
  geom_point() +
  geom_line(data = d1.1, aes(x = medPT, y = medCt), linewidth = 1, alpha = 0.3) +
  geom_line(data = d1.6, aes(x = medPT, y = medCt, group = Cancer_Type, 
                             color = Cancer_Type))
)

```


```{r Longitudinal trends of rT3 center across all discrete indicators}

p3 = list(
d1 %>% 
  ggplot(aes(x = medianPropTime, y = medianrT3)) +
  geom_point() +
  geom_line(data = d1.1, aes(x = medPT, y = medrT3), linewidth = 1, alpha = 0.3) +
  geom_line(data = d1.2, aes(x = medPT, y = medrT3, group = `factor(Age > 50)`, 
                             color = `factor(Age > 50)`))
,
d1 %>% 
  ggplot(aes(x = medianPropTime, y = medianrT3)) +
  geom_point() +
  geom_line(data = d1.1, aes(x = medPT, y = medrT3), linewidth = 1, alpha = 0.3) +
  geom_line(data = d1.3, aes(x = medPT, y = medrT3, group = Gender, 
                             color = Gender))
,
d1 %>% 
  ggplot(aes(x = medianPropTime, y = medianrT3)) +
  geom_point() +
  geom_line(data = d1.1, aes(x = medPT, y = medrT3), linewidth = 1, alpha = 0.3) +
  geom_line(data = d1.4, aes(x = medPT, y = medrT3, group = TSH_Risk_Level, 
                             color = TSH_Risk_Level))
,
d1 %>% 
  ggplot(aes(x = medianPropTime, y = medianrT3)) +
  geom_point() +
  geom_line(data = d1.1, aes(x = medPT, y = medrT3), linewidth = 1, alpha = 0.3) +
  geom_line(data = d1.5, aes(x = medPT, y = medrT3, group = Calcification_Presence, 
                             color = Calcification_Presence))
,
d1 %>% 
  ggplot(aes(x = medianPropTime, y = medianrT3)) +
  geom_point() +
  geom_line(data = d1.1, aes(x = medPT, y = medrT3), linewidth = 1, alpha = 0.3) +
  geom_line(data = d1.6, aes(x = medPT, y = medrT3, group = Cancer_Type, 
                             color = Cancer_Type))
)

```

